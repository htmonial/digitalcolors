<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<title>Digital Colors</title>
<style>
body { font-family: sans-serif; text-align: center; }
#bars { display: flex; flex-direction: column; width: 100%; margin-top: 20px; }
.bar { flex: 1; cursor: pointer; height: 20px; margin: 1px 0; }
canvas { border: none; margin-top: 20px; }
a:link, a:visited, a:hover, a:active { color: black; }
</style>
</head>
<body>
<h1>Submit one color per person</h1>

<input type="color" id="colorPicker">
<input type="text" id="colorText" placeholder="#RRGGBB">
<button id="submitColor">Submit color</button>
<button id="downloadBtn">Download PNG</button>

<div id="bars"></div>
<div id="colorInfo" style="margin-top:10px;font-weight:bold;"></div>
<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/tinycolor2@1.6.0/dist/tinycolor-min.js"></script>
<script>
const colorPicker = document.getElementById('colorPicker');
const colorText = document.getElementById('colorText');
const submitBtn = document.getElementById('submitColor');
const barsContainer = document.getElementById('bars');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const colorInfo = document.getElementById('colorInfo');

canvas.width = 1240;
canvas.height = 1754;

let colors = [];

colorPicker.addEventListener('input', () => colorText.value = colorPicker.value);
colorText.addEventListener('input', () => {
    if(/^#([0-9A-Fa-f]{6})$/.test(colorText.value)) colorPicker.value = colorText.value;
});

async function fetchColors() {
    const res = await fetch('/colors');
    colors = await res.json();
    renderBars();
}

function hexToRgb(hex) {
    return tinycolor(hex).toRgb();
}

// Simple rendering without perceptual sort
function renderBars() {
    barsContainer.innerHTML = '';
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const barHeight = canvas.height / colors.length;

    colors.forEach((c,i) => {
        const hex = c.color;
        const ts = c.timestamp || 'unknown';

        const div = document.createElement('div');
        div.className = 'bar';
        div.style.background = hex;
        div.addEventListener('click', () => {
            colorInfo.textContent = `Hex: ${hex} | Timestamp: ${ts}`;
        });
        barsContainer.appendChild(div);

        ctx.fillStyle = hex;
        ctx.fillRect(0,i*barHeight,canvas.width,barHeight);
    });
}

submitBtn.addEventListener('click', async () => {
    if(sessionStorage.getItem('submitted')){
        alert("Du kan kun indsende Ã©n farve pr. session!");
        return;
    }
    const newColor = colorText.value;
    if(!/^#([0-9A-Fa-f]{6})$/.test(newColor)){
        alert("Indtast en gyldig hex-farve!");
        return;
    }
    await fetch('/colors',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({color:newColor})
    });
    colors.push({ color: newColor, timestamp: new Date().toISOString() });
    sessionStorage.setItem('submitted','true');
    renderBars();
});

document.getElementById('downloadBtn').addEventListener('click',()=>{
    const link=document.createElement('a');
    link.download='farve_ark.png';
    link.href=canvas.toDataURL();
    link.click();
});

fetchColors();
</script>
</body>
</html>
